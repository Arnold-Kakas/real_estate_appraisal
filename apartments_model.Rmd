---
title: "apartments_model"
author: "Arnold Kakaš"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

create and evaluate models

```{r message=FALSE, warning=FALSE}
# import libs
if (!require("pacman")) {
  install.packages("pacman")
}

pacman::p_load(rio, 
               tidyverse,
               tidymodels,
               GGally,
               mice,
               patchwork,
               vip,
               parallel,
               dataPreparation,
               doParallel)
```


```{r}
# import data
apartments_analysis_data <- import("data/apartments_final_data.rds") |>
  filter(!is.na(price)) |>
  mutate(coord = st_coordinates(st_centroid(geometry)),
         lon = coord[, 1],
         lat = coord[, 2]) |>
  select(-coord)  # Optionally remove the original coordinates column

# remove geometry since we have coordinates now
apartments_analysis_data$geometry <- NULL


#apartments_analysis_data <- apartments_app_analysis_data
# apartments_app_analysis_data <- apartments_analysis_data
# apartments_app_analysis_data_sk <- apartments_analysis_data |>
#   mutate(district = "Slovensko",
#          district = as.factor(district))
# 
# apartments_app_analysis_data <- rbind(apartments_app_analysis_data_sk)
# 
# 
# saveRDS(apartments_app_analysis_data, "data/apartments_app_analysis_data.rds")



# apartments <- apartments_analysis_data |>
#   mutate(index = mean(as.numeric(index),na.rm = TRUE),
#          index = if_else(index > 0, index, NA),
#          IQR = IQR(price),
#          median = median(price),
#          lower = median - 1.5*IQR,
#          upper = median + 1.5*IQR,
#          ) |>
#   ungroup() |>
#   filter(price >= lower & price <= upper) |>
#   filter(area > 10 & area < 200) |>
#   filter(price < 400000) |>
#   select(-lower, -upper, -median, -IQR)



```



```{r}
# split dataframes to train(80)/test(20)
set.seed(123)
apartments_train_split <- initial_split(apartments_analysis_data, prop = 0.7, strata = price)

apartments_train <- training(apartments_train_split)
apartments_test <- testing(apartments_train_split)

saveRDS(apartments_test, "data/apartments_test.RDS")


folds <- vfold_cv(apartments_train, v = 5, strata = price)
```

```{r}
# recipes
apartments_xgboost_recipe <- recipe(apartments_train, price ~ .) |>
  step_rm(name_nsi) |> 
  step_string2factor(all_nominal_predictors()) |> 
  step_impute_knn(all_nominal_predictors()) |>
  step_unknown(all_nominal_predictors()) |>
  step_dummy(all_nominal_predictors())
```


```{r}
# models
xgb_model <-
  boost_tree(
    trees = tune(), loss_reduction = tune(),
    tree_depth = tune(), min_n = tune(),
    mtry = tune(), sample_size = tune(),
    learn_rate = tune()
  ) |>
  set_mode("regression") |>
  set_engine("xgboost")
```

```{r}
# workflows
apartments_workflow <- workflow() |>
  add_recipe(apartments_xgboost_recipe) |>
  add_model(xgb_model)
```

```{r}
# parameters
apartments_xgboost_params <- parameters(
  trees(), learn_rate(), loss_reduction(),
  tree_depth(), min_n(),  sample_size = sample_prop(),
  finalize(mtry(), apartments_train))

apartments_xgboost_params <- apartments_xgboost_params %>% update(trees = trees(c(300, 600))) 
```

```{r}
# optimization

registerDoParallel(cores = detectCores() - 2)

xgboost_tune <-
  apartments_workflow %>%
  tune_bayes(
    resamples = folds,
    param_info = apartments_xgboost_params,
    iter = 30, 
    metrics = metric_set(rmse, mape),
    control = control_bayes(no_improve = 10, 
                            save_pred = T, verbose = T)
  )

# doParallel::stopImplicitCluster()
autoplot(xgboost_tune)
```

```{r}

```


```{r}
# best models
apartments_best_model <- select_best(xgboost_tune, "rmse", maximize = FALSE)
```

```{r}
# finalize models
apartments_final_model <- finalize_model(xgb_model, apartments_best_model)
apartments_workflow <- apartments_workflow |>update_model(apartments_final_model)
apartments_xgb_fit <- fit(apartments_workflow, data = apartments_train)
```

```{r}
apartments_xgb_fit |>
  fit(data = apartments_train) |>
  pull_workflow_fit() |>
  vip(geom = "point")
```

```{r}
apartments_final_res <- last_fit(apartments_xgb_fit, apartments_train_split)
collect_metrics(apartments_final_res)
```

```{r}
# evaluate
apartments_pred <-
  predict(apartments_xgb_fit, apartments_test) |>
  bind_cols(apartments_test)

# |>
#   mutate(prediction = 10^.pred,
#          real_price = 10^price)

apartments_plot1 <-
  apartments_pred |>
  ggplot(aes(x = .pred, y = price)) +
  geom_point() +
  geom_abline(intercept = 0, col = "red")


apartments_plot2 <-
  apartments_pred |>
  select(.pred, price) |>
  gather(key, value) |>
  ggplot(aes(x = value, volor = key, fill = key)) +
  geom_density(alpha = .2) +
  labs(x = "", y = "")

apartments_plot1 / apartments_plot2
```

```{r}
# save model
saveRDS(apartments_xgb_fit, "data/model.RDS")

# # save other data for app
# conditions <- scraped_cleaned_wo_outliers_wo_geometry |>select(condition) |>distinct()
# saveRDS(conditions, "data/conditions.RDS")
# 
# certificate <- scraped_cleaned_wo_outliers_wo_geometry |>select(certificate) |>distinct()
# saveRDS(certificate, "data/certificate.RDS")
# 
# type <- scraped_cleaned_wo_outliers_wo_geometry |>select(type) |>distinct()
# saveRDS(type, "data/type.RDS")
```

```{r}
test <- data.frame(name_nsi = "Senec",
                 district = "Senec",
                 index = NA,
                 condition = "Novostavba",
                 area = 72,
                 provision = "Nie",
                 certificate = "nemá",
                 type = "3 izbový byt",
                 rooms = 3,
                 index_mean_district = 6.3
                 )


test_pred <-
  predict(apartments_xgb_fit, test) |>
  bind_cols(test)
```



