---
title: "Pricing model evaluation"
author: "Arnold Kaka≈°"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Price prediction model

### Introduction

In this post I will go through <strong> price prediction model </strong> based on dataset [explored]() in my previous post.

<br>

Data is scraped from [Nehnutelnosti](https://www.nehnutelnosti.sk/) website that specializes in real estate listings and services. I will go through the scraping process and initial data cleaning in more details in the next blog post.


### Libraries
```{r message=FALSE, warning=FALSE}
# load libs
pacman::p_load(rio, 
               tidyverse,
               tidymodels)
               
```


### Final pricing model
Since the goal of this model is to predict price XXXXXXXXXXXXXXXXXXXXXXXXXXX

<br>

The word "Final" in this section may tell you, that there were multiple versions of the model. Indeed, I tried several models - linear regression, random forest and xgboost. 

### Model evaluation

For model evaluation I will use test data dataframe that was used also in modeling process.
```{r}
# load data for model evaluation
apartments_test <- import("data/apartments_test.RDS")
model <- import("data/model.RDS")
```


```{r}
model %>%
  fit(data = apartments_test) %>%
  pull_workflow_fit() %>%
  vip(num_features = 10,
      geom = "point")
```

```{r}
set.seed(123)
apartments_train_split <- initial_split(apartments_analysis_data, prop = 0.8, strata = price)
results <- last_fit(model, apartments_train_split)
collect_metrics(results) %>%
  mutate(Estimate = round(.estimate, 3),
         Metric = .metric) %>% 
  select(Metric, Estimate) 

```

```{r}
# evaluate
apartments_pred <-
  predict(apartments_xgb_fit, apartments_test) %>%
  bind_cols(apartments_test)

# %>% 
#   mutate(prediction = 10^.pred,
#          real_price = 10^price)

apartments_plot1 <-
  apartments_pred %>%
  ggplot(aes(x = .pred, y = price)) +
  geom_point() +
  geom_abline(intercept = 0, col = "red")


apartments_plot2 <-
  apartments_pred %>%
  select(.pred, price) %>%
  gather(key, value) %>%
  ggplot(aes(x = value, volor = key, fill = key)) +
  geom_density(alpha = .2) +
  labs(x = "", y = "")

apartments_plot1 / apartments_plot2
```