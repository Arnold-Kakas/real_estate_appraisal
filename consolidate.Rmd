---
title: "consolidate"
author: "Arnold Kaka≈°"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Consolidate data scraped from web and geospatial data

```{r}
# import libraries

library(pacman)
p_load(
  tidyverse,
  rio,
  skimr,
  sf,
  ggmap,
  plotly
)
```

```{r}
# load data
scraped_data <- import("data/advertisements.rds")
geocoded_data <- import("data/geospatial_data/geocodes.csv")
```

```{r}
scraped_data <- scraped_data %>%
  filter(!is.na(price)) %>%
  filter(if_all(
    where(is.numeric),
    ~ between(price, quantile(price, .02), quantile(price, .98))
  )) %>%
  mutate(
    district = str_replace_all(district, "okres ", ""),
    address = paste(municipality, district, "Slovakia", sep = ", "),
    price = log(price + 1)
  ) %>%
  select(-c(c))

 skim(scraped_data)

# check what is c column and correct in scraping code
```

```{r}
# tidy geocoded data
geocoded_data <- geocoded_data %>%
  transmute(
    address = V2,
    lon = V3,
    lat = V4
  ) %>%
  slice(-1) %>%
  mutate(
    lon = as.numeric(str_replace_all(lon, ",", ".")),
    lat = as.numeric(str_replace_all(lat, ",", "."))
  )
```

```{r}
merged_data <- scraped_data %>%
  left_join(geocoded_data, by = "address")
```

```{r label}
# check for missing geocodes
missing_geocodes <- merged_data %>%
  filter(is.na(lat)) %>%
  select(c(address)) %>%
  distinct()
is_missing <- length(missing_geocodes) > 1
```

```{r conditional, eval = is_missing}
# if there are missing geocodes, this code will be executed
api_key <- ""
register_google(key = api_key)
geocodes <- geocode(missing_geocodes$address, output = "latlon", source = "google")
missing_geocodes <- cbind(missing_geocodes, geocodes)
rm(api_key, geocodes)

geocoded_data <- bind_rows(geocoded_data, missing_geocodes)
write.csv2(geocoded_data, "data/geospatial_data/geocodes.csv")

merged_data <- merged_data %>%
  left_join(missing_geocodes, by = "address") %>%
  mutate(
    lat = coalesce(lat.x, lat.y),
    lon = coalesce(lon.x, lon.y)
  ) %>%
  select(-c(lat.x, lat.y, lon.x, lon.y))
```

```{r}
price_sf <- merged_data %>%
  group_by(lat, lon) %>%
  summarize(price = mean(price)) %>%
  st_as_sf(coords = c("lon", "lat"))

price_sf <- st_set_crs(price_sf, 4326)

map <- ggplot(price_sf) +
  geom_sf(aes(col = price)) +
  scale_fill_brewer(palette = "YlOrRd")
ggplotly(map)
```

```{r}
p_load(colorRamps)
price_sf %>%
  ggplot(aes(col = price)) +
  geom_sf() +
  scale_colour_stepsn(colours = colorRamps::green2red(10), )
```
next steps
rotate coordinates